"use strict";angular.module("LiveSearch",["ng"]).directive("liveSearch",["$compile","$timeout",function(e,t){return{restrict:"E",replace:!0,scope:{liveSearchCallback:"=",liveSearchSelect:"=?",liveSearchItemTemplate:"@",liveSearchWaitTimeout:"=?",liveSearchMaxResultSize:"=?"},template:"<input type='text' />",link:function(l,i,n){var c;l.results=[],l.visible=!1,l.selectedIndex=-1,l.select=function(e){l.selectedIndex=e,l.visible=!1},l.isSelected=function(e){return l.selectedIndex===e},l.$watch("selectedIndex",function(e){var t=l.results[e];t&&i.val(n.liveSearchSelect?t[n.liveSearchSelect]:t),"undefined"!==i.controller("ngModel")&&i.controller("ngModel").$setViewValue(i.val())}),l.$watch("visible",function(e){if(0!=e){l.width=i[0].clientWidth;var t=s(i[0]);l.top=t.y+i[0].clientHeight+1,l.left=t.x}}),i[0].onkeydown=function(e){40==e.keyCode?l.selectedIndex+1===l.results.length?l.selectedIndex=0:l.selectedIndex++:38==e.keyCode&&(0==l.selectedIndex?l.selectedIndex=l.results.length-1:-1==l.selectedIndex?l.selectedIndex=0:l.selectedIndex--),13==e.keyCode&&(l.visible=!1),l.$apply()},i[0].onkeyup=function(e){if(13==e.keyCode||37==e.keyCode||38==e.keyCode||39==e.keyCode||40==e.keyCode)return!1;var n=i;t.cancel(c);var s=n.val().split(","),r=s[s.length-1].trim();return r.length<3||r.length>9?(l.visible=!1,void l.$apply()):void(c=t(function(){var e=[],t=l.liveSearchCallback.call(null,{query:r});t.then(function(t){t&&(e=t.slice(0,(l.liveSearchMaxResultSize||20)-1)),l.visible=!0}),t.finally(function(){l.selectedIndex=-1,l.results=e.filter(function(t,l){return e.indexOf(t)==l})})},l.liveSearchWaitTimeout||100))};var s=function(e){for(var t=0,l=0;e;)t+=e.offsetLeft-e.scrollLeft+e.clientLeft,l+=e.offsetTop-e.scrollTop+e.clientTop,e=e.offsetParent;return{x:t,y:l}},r=i.attr("live-search-item-template")||"{{result}}",d="<ul ng-show='visible' style='top:{{top}}px;left:{{left}}px;width:{{width}}px;' class='searchresultspopup'><li ng-class=\"{ 'selected' : isSelected($index) }\" ng-click='select($index)' ng-repeat='result in results'>"+r+"</li></ul>",o=e(d)(l);document.body.appendChild(o[0])}}}]);
