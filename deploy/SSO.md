## Single Sign-On

The Hub's `oauth2_proxy` instance is configured as a single sign-on service
for multiple 18f.gov sub-domains using a single set of MyUSA OAuth
credentials. The configuration, inspired by the instructions in
[bitly/oauth2_proxy#12](https://github.com/bitly/oauth2_proxy/issues/12), is
subtle, but effective.

### MyUSA

The **Redirect uri** field in the Hub's MyUSA application settings is set to
`https://auth.18f.gov/oauth2/callback`. auth.18f.gov is defined in
`auth.conf`, described below.

### /usr/local/18f/etc/oauth2_proxy.cfg

These are the critical two lines:

```
redirect_url = "https://auth.18f.gov/oauth2/callback"
cookie_domain = ".18f.gov"
```

The `cookie_domain` ensures that a single `.18f.gov` auth cookie will provide
access to any application hosted on an 18f.gov sub-domain (for which the Hub's
`oauth2_proxy` is configured to act as a reverse proxy, of course).

### /etc/nginx/vhosts/auth-locations.conf

Include this file at the end of every Nginx `server` block for which you want
the `oauth2_proxy` to provide authentication. The `location /` block is the
normal case; after the user is authenticated, all requests will be routed
through this block and passed to the `oauth2_proxy`.

```
location / {
  proxy_pass http://127.0.0.1:4180/;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Scheme $scheme;
  proxy_connect_timeout 1;
  proxy_send_timeout 30;
  proxy_read_timeout 30;
}
```

The `location = /oauth2/start` block is almost identical, but performs part of
the magic hack that makes single sign-on work. It sets the prefix of the `rd`
(short for "redirect") parameter of the `/oauth2/start` query string to the
name of the server in which this block is included.

For example, for hub.18f.gov/foo, it will be `rd=%2Fhub.18f.gov/foo`. `%2F` is
the hex-encoded version of the `/` character, so this is saying that once
authentication is complete, the `oauth2_proxy` should redirect back to
`/hub.18f.gov/foo`. As we will see, the full URL of the redirect will be
`https://auth.18f.gov/hub.18f.gov/foo`.

```
location = /oauth2/start {
  proxy_pass http://127.0.0.1:4180/oauth2/start?rd=%2F$server_name$arg_rd;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Scheme $scheme;
  proxy_connect_timeout 1;
  proxy_send_timeout 30;
  proxy_read_timeout 30;
}
```

### /etc/nginx/vhosts/auth.conf

This file defines the `auth.18f.gov` server. The `/oauth2/callback` block
forwards the request from the OAuth provider to the `oauth2_proxy` running
locally on port 4180:

```
  location = /oauth2/callback {
    proxy_pass http://127.0.0.1:4180;
    proxy_connect_timeout 1;
    proxy_send_timeout 30;
    proxy_read_timeout 30;
  }
```

After the OAuth handshake succeeds, the `oauth2_proxy` will redirect back to
the `rd` URL generated by the `/oauth/start` block from above. The following
block parses the target host (e.g. hub.18f.gov) from the redirected request
and forwards the request to the target host. Using the earlier example,
`https://auth.18f.gov/hub.18f.gov/foo` will be rewritten as
`https://hub.18f.gov/foo`.

```
  location "~^/(?<target_host>[^/]+).18f.gov/(?<remaining_uri>.*)$" {
    rewrite ^ $scheme://$target_host$remaining_uri;
  }
```

Note that the `location` expression matches `.18f.gov/` explicitly. This is to
prevent [open redirect vulnerabilities](https://www.owasp.org/index.php/Open_redirect).
[Phishing attacks](https://www.owasp.org/index.php/Phishing) can take
advantage of open redirects to send users to malicious sites without realizing
it, because the link appears to come from your trusted domain.

### .conf files

Now, create a `/etc/nginx/vhosts/[YOUR-PROJECT].conf` file and include
the `auth-locations.conf` file in the bottom of the `server` block that
defines the https server:

```
  include vhosts/auth-locations.conf;
```
